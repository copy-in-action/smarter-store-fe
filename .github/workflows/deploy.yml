name: Deploy Next.js

on:
  push:
    branches: [ci-github-action]
  pull_request:
    branches: [main]

env:
  DOCKER_IMAGE_NAME: ticket-fe
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  # 브랜치명-PR번호 형태 태그 생성
  IMAGE_TAG: ${{ github.head_ref || github.ref_name }}-${{ github.event.number || github.run_number }}

jobs:
  build:
    runs-on: self-hosted
    container:
      image: node:22
      volumes:
        # pnpm 캐시만 로컬 호스트에서 마운트
        - /home/cic/.pnpm-store:/root/.pnpm-store
        
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Next.js 빌드 캐시 복원 (Turbopack 호환)
      - name: Restore Next.js cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-turbo-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('next.config.ts', 'tailwind.config.*', 'tsconfig.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-turbo-${{ hashFiles('**/pnpm-lock.yaml') }}-
            ${{ runner.os }}-nextjs-turbo-

      # pnpm 설치
      - name: Install pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      # pnpm store 설정 및 의존성 설치
      - name: Install dependencies
        run: |
          pnpm config set store-dir /root/.pnpm-store
          pnpm i

      # 빌드
      - name: Build
        run: pnpm build
        env:
          NODE_ENV: production

      # 빌드 결과물 권한 변경
      - name: Fix build output permissions
        run: |
          chmod -R 755 .next/
          chmod -R 755 public/
          chmod 644 Dockerfile .dockerignore

  deploy:
    runs-on: self-hosted
    needs: build
    steps:
      # Docker 이미지 빌드 및 GitHub Container Registry 푸시
      - name: Build and push Docker image
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          
          # 빌드와 동시에 registry 태그로 생성
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
                       -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest .
          
          # 로컬용 태그 생성
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest ${{ env.DOCKER_IMAGE_NAME }}:latest
          
          # GitHub Container Registry에 푸시
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

      # Docker Compose로 배포
      - name: Deploy with Docker Compose
        run: |
          cd ${{ vars.DOCKER_COMPOSE_PATH }}
          docker compose down || true
          docker compose up -d