name: Deploy Next.js

on:
  push:
    branches: [ci-github-action]
  pull_request:
    branches: [main]

env:
  DOCKER_IMAGE_NAME: ticket-fe

jobs:
  build:
    runs-on: self-hosted
    container:
      image: node:22
      volumes:
        # pnpm 캐시만 로컬 호스트에서 마운트
        - /home/cic/.pnpm-store:/root/.pnpm-store
        
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Next.js 빌드 캐시 복원 (Turbopack 호환)
      - name: Restore Next.js cache
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/.next/cache
          key: ${{ runner.os }}-nextjs-turbo-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('next.config.ts', 'tailwind.config.*', 'tsconfig.json') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-turbo-${{ hashFiles('**/pnpm-lock.yaml') }}-
            ${{ runner.os }}-nextjs-turbo-

      # pnpm 설치
      - name: Install pnpm
        run: |
          corepack enable
          corepack prepare pnpm@latest --activate

      # 의존성 설치
      - name: Install dependencies
        run: pnpm i

      # 빌드
      - name: Build
        run: pnpm build
        env:
          NODE_ENV: production

      # 빌드 결과물 권한 변경
      - name: Fix build output permissions
        run: |
          chmod -R 755 .next/
          chmod -R 755 public/
          chmod 644 Dockerfile .dockerignore

      # 빌드 아티팩트 및 Docker 파일 업로드
      - name: Upload build and Docker files
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          path: |
            .next/
            public/
            Dockerfile
            .dockerignore
          retention-days: 1

  deploy:
    runs-on: self-hosted
    needs: build
    steps:
      # 빌드 결과 및 Docker 파일 다운로드
      - name: Download build and Docker files
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
        
      # Docker 이미지 빌드
      - name: Build Docker image
        run: docker build -t ${{ env.DOCKER_IMAGE_NAME }} .

      # Docker Compose로 배포
      - name: Deploy with Docker Compose
        run: |
          cd ${{ vars.DOCKER_COMPOSE_PATH }}
          docker-compose down ${{ env.DOCKER_IMAGE_NAME }} || true
          docker-compose up -d ${{ env.DOCKER_IMAGE_NAME }}