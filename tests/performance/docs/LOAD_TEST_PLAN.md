# 공연 예매 시스템 부하 테스트 플랜

## 문서 정보

| 항목 | 내용 |
|------|------|
| 작성일 | 2026-01-29 |
| 프로젝트 | Smarter Store 티켓 예매 시스템 |
| 테스트 대상 | 예매 프로세스 (좌석 선택 ~ 결제 완료) |
| 테스트 도구 | k6 (Grafana Labs) |

---

## 1. 테스트 목적 및 목표

### 1.1 테스트 목적

공연 예매 시스템의 안정성과 성능을 검증하여 실제 서비스 오픈 시 대량의 동시 접속을 안정적으로 처리할 수 있는지 확인합니다.

### 1.2 주요 검증 항목

#### 동시성 제어 (Concurrency Control)
- **목표**: 여러 사용자가 동시에 같은 좌석을 예약할 때 정확히 1명만 성공
- **검증 방법**: 100명이 동시에 동일 좌석 예약 시도 → 1명 성공, 99명 409 Conflict
- **중요도**: ★★★★★ (Critical)

#### 성능 목표 (Performance SLA)
| 메트릭 | 목표값 | 측정 지점 |
|--------|--------|-----------|
| 평균 응답 시간 | < 1초 | 모든 API |
| P95 응답 시간 | < 2초 | 모든 API |
| P99 응답 시간 | < 3초 | 모든 API |
| 예매 API 응답 | < 1.5초 | POST /bookings/start |
| 처리량 (TPS) | > 50 TPS | 전체 시스템 |
| 에러율 | < 1% | 정상 시나리오 |
| CPU 사용률 | < 70% | 서버 인스턴스 |
| 메모리 사용률 | < 80% | 서버 인스턴스 |

#### 스케일 테스트
- **목표**: 동시 접속자 수 한계점 파악
- **테스트 범위**: 100명 → 500명 → 1,000명 → 2,000명
- **성공 기준**: 목표 동시 접속자 수에서 SLA 충족

#### 안정성 테스트 (Soak Test)
- **목표**: 장시간 운영 시 메모리 누수, 커넥션 풀 고갈 등 확인
- **테스트 시간**: 1시간 이상
- **모니터링**: 메모리, DB 커넥션, 스레드 풀

---

## 2. 테스트 범위

### 2.1 테스트 대상 API

| API 엔드포인트 | HTTP Method | 설명 | 우선순위 |
|----------------|-------------|------|----------|
| `/auth/login` | POST | 사용자 로그인 | High |
| `/bookings/start` | POST | 좌석 점유 (예매 시작) | **Critical** |
| `/bookings/{id}/time` | GET | 예매 남은 시간 조회 | Medium |
| `/payments` | POST | 결제 생성 | High |
| `/payments/{id}/complete` | POST | 결제 완료 | High |
| `/bookings/{id}` | DELETE | 예매 취소 | Medium |
| `/schedules/{id}/seat-status` | GET | 좌석 상태 조회 | Low |

### 2.2 테스트 제외 항목

- 관리자 API
- 이미지 업로드
- 파일 다운로드
- SSE (Server-Sent Events) 실시간 좌석 업데이트
  - 이유: k6는 SSE를 완벽히 지원하지 않으며, 별도 도구 필요

### 2.3 테스트 환경

| 항목 | 내용 |
|------|------|
| **환경** | Staging (운영 환경과 동일 스펙) |
| **API URL** | `https://ticket-api.devhong.cc/api` |
| **데이터베이스** | 테스트 전용 DB (운영 DB와 분리) |
| **서버 스펙** | (백엔드 팀에서 제공 필요) |
| **네트워크** | 외부 인터넷 환경에서 접근 |

---

## 3. 테스트 시나리오

### 3.1 시나리오 1: 정상 예매 플로우 (Happy Path)

**목적**: 일반적인 사용자의 예매 프로세스 성능 검증

**사용자 행동**:
```
1. 로그인 (POST /auth/login)
   ↓ (1초 대기)
2. 좌석 선택 및 점유 (POST /bookings/start)
   ↓ (2초 대기 - 사용자가 정보 확인)
3. 결제 생성 (POST /payments)
   ↓ (1초 대기 - PG 화면 전환)
4. 결제 완료 (POST /payments/{id}/complete)
   ↓ (1초 대기 - 결과 확인)
5. 종료
```

**부하 패턴**:
```javascript
stages: [
  { duration: '1m', target: 50 },   // 1분간 50명으로 증가
  { duration: '3m', target: 50 },   // 3분간 50명 유지
  { duration: '1m', target: 100 },  // 1분간 100명으로 증가
  { duration: '3m', target: 100 },  // 3분간 100명 유지
  { duration: '1m', target: 0 },    // 1분간 0명으로 감소
]
```

**성공 기준**:
- [ ] 모든 단계 성공률 > 95%
- [ ] P95 응답 시간 < 2초
- [ ] 에러율 < 1%

---

### 3.2 시나리오 2: 좌석 충돌 테스트 (Concurrency Test)

**목적**: 동시성 제어 로직 검증

**사용자 행동**:
```
1. 사전에 로그인 완료 (1개 계정)
2. 100명이 동시에 같은 좌석 예약 시도
3. 결과 확인
```

**테스트 설정**:
```javascript
vus: 100,              // 동시 100명
duration: '10s',       // 10초간 반복
iterations: 100,       // 총 100회 시도
```

**예상 결과**:
- 성공 (200): **정확히 1건**
- 충돌 (409): 99건
- 기타 에러: 0건

**성공 기준**:
- [ ] 정확히 1명만 예매 성공
- [ ] 나머지는 모두 409 Conflict 응답
- [ ] 모든 응답 시간 < 2초
- [ ] 데이터 정합성 확인 (DB에 1건만 저장)

**검증 방법**:
```sql
-- 테스트 후 DB 확인
SELECT COUNT(*) FROM booking
WHERE schedule_id = {TEST_SCHEDULE_ID}
  AND seat_row = {TEST_ROW}
  AND seat_col = {TEST_COL}
  AND status IN ('PENDING', 'CONFIRMED');
-- 결과: 1건이어야 함
```

---

### 3.3 시나리오 3: 스파이크 테스트 (Spike Test)

**목적**: 갑작스러운 트래픽 폭증 시 시스템 안정성 검증

**사용 사례**: 인기 공연 티켓 오픈 시점

**부하 패턴**:
```javascript
stages: [
  { duration: '10s', target: 10 },    // 평소 트래픽
  { duration: '10s', target: 500 },   // 갑자기 500명으로 증가
  { duration: '30s', target: 500 },   // 500명 유지
  { duration: '10s', target: 10 },    // 평소 트래픽으로 복귀
]
```

**성공 기준**:
- [ ] 스파이크 구간 에러율 < 5%
- [ ] 시스템 크래시 없음
- [ ] 트래픽 감소 후 정상 복구

---

### 3.4 시나리오 4: 내구성 테스트 (Soak Test)

**목적**: 장시간 운영 시 메모리 누수, 리소스 고갈 등 확인

**부하 패턴**:
```javascript
stages: [
  { duration: '5m', target: 50 },     // 5분간 50명으로 증가
  { duration: '60m', target: 50 },    // 1시간 동안 50명 유지
  { duration: '5m', target: 0 },      // 5분간 0명으로 감소
]
```

**모니터링 항목**:
- 메모리 사용량 추이
- DB 커넥션 풀 상태
- 스레드 풀 상태
- GC 빈도 및 시간

**성공 기준**:
- [ ] 메모리 사용량이 일정 수준 유지 (계속 증가하지 않음)
- [ ] DB 커넥션 누수 없음
- [ ] 응답 시간이 점진적으로 증가하지 않음

---

### 3.5 시나리오 5: 스트레스 테스트 (Stress Test)

**목적**: 시스템의 한계점 파악

**부하 패턴**:
```javascript
stages: [
  { duration: '2m', target: 100 },
  { duration: '2m', target: 200 },
  { duration: '2m', target: 500 },
  { duration: '2m', target: 1000 },
  { duration: '2m', target: 1500 },
  { duration: '2m', target: 2000 },   // 한계 테스트
  { duration: '5m', target: 0 },
]
```

**측정 항목**:
- 각 단계별 성공률
- 응답 시간 변화
- 시스템이 견딜 수 있는 최대 동시 접속자 수

---

## 4. 테스트 데이터 준비

### 4.1 테스트 계정

**필요 계정 수**: 최소 100개 ~ 최대 2,000개

**계정 생성 방법**:
```
옵션 1: 백엔드 시드 스크립트
- 이메일: loadtest1@example.com ~ loadtest2000@example.com
- 비밀번호: TestPassword123!

옵션 2: 단일 계정 + 토큰 재사용
- 간단한 테스트 시 사용
- 제약: 동일 사용자가 여러 예매 불가능
```

### 4.2 공연 및 회차 데이터

**필요 데이터**:
```
1. 테스트용 공연 1개
2. 공연 회차 최소 5개 (시나리오별 분리)
3. 각 회차당 100석 이상
```

**준비 방법**:
- 백엔드 팀에 테스트 데이터 시드 스크립트 요청
- 또는 관리자 페이지에서 수동 생성

### 4.3 좌석 데이터

**좌석 배치도**:
```
- 행(row): 1 ~ 10
- 열(col): 1 ~ 10
- 총 좌석 수: 100석
```

**좌석 등급**:
```
- VIP: 1-2행 (20석)
- R석: 3-6행 (40석)
- S석: 7-10행 (40석)
```

---

## 5. 테스트 실행 계획

### 5.1 테스트 일정

| 단계 | 일정 | 담당 | 산출물 |
|------|------|------|--------|
| 환경 준비 | D-5 | DevOps | 스테이징 환경 |
| 데이터 준비 | D-4 | Backend | 시드 스크립트 |
| 스크립트 작성 | D-3 ~ D-2 | QA/Frontend | k6 스크립트 |
| 예비 테스트 | D-1 | QA | 사전 검증 |
| 본 테스트 | D-Day | 전체 팀 | 테스트 결과 |
| 결과 분석 | D+1 | QA/Backend | 분석 보고서 |
| 개선 작업 | D+2 ~ | Backend | 성능 개선 |

### 5.2 테스트 순서

```
Day 1:
  1. 시나리오 1 (정상 플로우) - 10명
  2. 시나리오 1 (정상 플로우) - 50명
  3. 시나리오 2 (좌석 충돌) - 100명

Day 2:
  4. 시나리오 1 (정상 플로우) - 100명
  5. 시나리오 3 (스파이크) - 500명 피크
  6. 결과 분석 및 개선점 도출

Day 3:
  7. 시나리오 5 (스트레스) - 한계 테스트
  8. 시나리오 4 (내구성) - 1시간 테스트
  9. 최종 결과 정리
```

### 5.3 실행 전 체크리스트

#### 환경 체크
- [ ] 스테이징 서버 정상 동작 확인
- [ ] 데이터베이스 백업 완료
- [ ] 모니터링 도구 설정 완료 (Grafana, Prometheus 등)
- [ ] 로그 수집 설정 완료

#### 데이터 체크
- [ ] 테스트 계정 생성 완료
- [ ] 테스트 공연/회차 생성 완료
- [ ] 좌석 데이터 초기화 완료

#### 스크립트 체크
- [ ] k6 설치 완료
- [ ] 테스트 스크립트 동작 확인 (1명으로 테스트)
- [ ] 환경 변수 설정 완료

#### 팀 체크
- [ ] 백엔드 팀 대기 (실시간 모니터링)
- [ ] DevOps 팀 대기 (인프라 모니터링)
- [ ] QA 팀 실행 준비 완료

---

## 6. 모니터링 및 측정

### 6.1 애플리케이션 메트릭

**k6 기본 메트릭**:
```
- http_reqs: 총 요청 수
- http_req_duration: 요청 응답 시간 (avg, p50, p95, p99, max)
- http_req_failed: 실패한 요청 수
- vus: 가상 유저 수
- iterations: 완료된 반복 수
```

**커스텀 메트릭**:
```javascript
- booking_success_rate: 예매 성공률
- payment_success_rate: 결제 성공률
- conflict_errors: 좌석 충돌 에러 수 (409)
- timeout_errors: 타임아웃 에러 수 (408, 504)
```

### 6.2 서버 메트릭

**시스템 리소스**:
- CPU 사용률 (per core)
- 메모리 사용률
- 디스크 I/O
- 네트워크 대역폭

**애플리케이션**:
- JVM Heap 메모리 (Java 사용 시)
- GC 빈도 및 시간
- 스레드 풀 사용률
- 에러 로그 발생 건수

**데이터베이스**:
- 커넥션 풀 사용률
- 쿼리 실행 시간
- Slow Query 발생 건수
- Lock 대기 시간

### 6.3 모니터링 도구

| 도구 | 용도 | 담당 |
|------|------|------|
| k6 | 부하 생성 및 클라이언트 메트릭 | QA |
| Grafana | 실시간 메트릭 시각화 | DevOps |
| Prometheus | 메트릭 수집 | DevOps |
| APM (New Relic 등) | 애플리케이션 성능 추적 | Backend |
| DB Monitor | 데이터베이스 성능 추적 | Backend |

---

## 7. 결과 분석 기준

### 7.1 성공/실패 기준

#### ✅ 성공 기준
- 모든 시나리오에서 목표 SLA 달성
- 동시성 제어 100% 정확도
- 시스템 크래시 없음
- 데이터 정합성 100%

#### ❌ 실패 기준
- 응답 시간 SLA 미달
- 에러율 > 5%
- 좌석 중복 예약 발생
- 시스템 다운타임 발생

### 7.2 분석 항목

#### 성능 분석
```
1. 병목 구간 식별
   - 어느 API가 가장 느린가?
   - 어느 구간에서 에러가 많이 발생하는가?

2. 리소스 분석
   - CPU/메모리/DB 중 어느 것이 먼저 한계에 도달하는가?
   - 스케일 아웃으로 해결 가능한가?

3. 동시성 분석
   - 락(Lock) 경합이 많이 발생하는가?
   - 데드락이 발생하는가?
```

#### 안정성 분석
```
1. 에러 패턴
   - 어떤 상황에서 에러가 발생하는가?
   - 에러 후 복구가 가능한가?

2. 리소스 누수
   - 메모리가 계속 증가하는가?
   - 커넥션이 제대로 반환되는가?

3. 예외 상황
   - 타임아웃 발생 시 어떻게 동작하는가?
   - 부분 실패 시 데이터 정합성이 유지되는가?
```

### 7.3 보고서 형식

```markdown
# 부하 테스트 결과 보고서

## 요약
- 테스트 일시: YYYY-MM-DD
- 테스트 시나리오: [시나리오명]
- 최대 동시 접속: XXX명
- 전체 성공률: XX%

## 주요 메트릭
| 메트릭 | 목표 | 실제 | 달성 여부 |
|--------|------|------|-----------|
| P95 응답시간 | < 2초 | X.Xs | ✅/❌ |
| 에러율 | < 1% | X% | ✅/❌ |
| TPS | > 50 | XX | ✅/❌ |

## 문제점 및 개선 사항
1. [문제점]
   - 원인: ...
   - 개선 방안: ...

## 결론
- 시스템 안정성: [평가]
- 권장 사항: [권장 사항]
```

---

## 8. 위험 요소 및 대응 방안

### 8.1 테스트 중 발생 가능한 문제

| 위험 | 영향도 | 발생 확률 | 대응 방안 |
|------|--------|-----------|-----------|
| 운영 DB 접근 | Critical | Low | 환경 변수 이중 확인, IP 차단 |
| 실결제 발생 | High | Medium | PG 테스트 모드 사용 |
| 서버 크래시 | High | Medium | 자동 재시작 설정, 알림 |
| 테스트 데이터 부족 | Medium | High | 사전 데이터 검증 |
| 네트워크 불안정 | Medium | Low | 재시도 로직, 타임아웃 설정 |

### 8.2 긴급 중단 기준

다음 상황 발생 시 즉시 테스트 중단:
- 운영 DB에 테스트 데이터 유입
- 실결제 발생
- 서버 크래시 반복 (3회 이상)
- 데이터 손실 감지

---

## 9. 테스트 후 작업

### 9.1 데이터 정리

```sql
-- 테스트 계정 삭제
DELETE FROM users WHERE email LIKE 'loadtest%@example.com';

-- 테스트 예매 삭제
DELETE FROM booking WHERE created_at > '{TEST_START_TIME}';

-- 테스트 결제 삭제
DELETE FROM payment WHERE created_at > '{TEST_START_TIME}';
```

### 9.2 환경 복원

- [ ] 서버 설정 원복
- [ ] 데이터베이스 복원 (필요 시)
- [ ] 로그 아카이빙
- [ ] 모니터링 대시보드 저장

### 9.3 개선 작업

우선순위에 따라 성능 개선:
1. **Critical**: 동시성 버그, 데이터 정합성 이슈
2. **High**: 응답 시간 SLA 미달
3. **Medium**: 에러율 목표 미달
4. **Low**: 사용자 경험 개선

---

## 10. 참고 자료

### 10.1 관련 문서
- [k6 공식 문서](https://k6.io/docs/)
- [부하 테스트 베스트 프랙티스](https://k6.io/docs/testing-guides/load-testing/)
- [API 명세서](https://ticket-api.devhong.cc/swagger-ui.html)

### 10.2 유사 사례
- 티켓링크 부하 테스트 사례
- 인터파크 티켓 성능 개선 사례
- YES24 티켓 동시성 제어 사례

### 10.3 도구 비교

| 도구 | 장점 | 단점 | 추천 용도 |
|------|------|------|-----------|
| k6 | 가볍고 빠름, JavaScript | SSE 미지원 | API 부하 테스트 |
| JMeter | GUI, 다양한 프로토콜 | 무겁고 느림 | 복잡한 시나리오 |
| Gatling | Scala 기반, 실시간 리포트 | 학습 곡선 높음 | 대규모 테스트 |
| Locust | Python, 확장성 우수 | 단일 스레드 제약 | 커스텀 테스트 |

---

## 11. 체크리스트

### 테스트 전
- [ ] 테스트 목표 명확화
- [ ] 테스트 환경 준비 완료
- [ ] 테스트 데이터 생성 완료
- [ ] 테스트 스크립트 검증 완료
- [ ] 모니터링 도구 설정 완료
- [ ] 관련 팀 공지 완료

### 테스트 중
- [ ] 실시간 모니터링
- [ ] 이상 징후 즉시 보고
- [ ] 로그 기록
- [ ] 스크린샷/화면 녹화

### 테스트 후
- [ ] 결과 데이터 백업
- [ ] 테스트 환경 정리
- [ ] 보고서 작성
- [ ] 개선 작업 계획 수립
- [ ] 재테스트 일정 수립

---

## 부록 A: 용어 정의

| 용어 | 설명 |
|------|------|
| VU (Virtual User) | 가상 유저, 동시 접속자를 시뮬레이션하는 단위 |
| TPS (Transaction Per Second) | 초당 처리 건수 |
| P95 | 95 백분위수, 전체 요청 중 95%가 이 값 이하 |
| Ramp-up | 부하를 점진적으로 증가시키는 것 |
| Spike | 갑작스러운 부하 증가 |
| Soak Test | 장시간 일정 부하를 유지하는 테스트 |
| Stress Test | 시스템 한계를 찾는 테스트 |

---

## 부록 B: 문의처

| 담당 | 연락처 | 역할 |
|------|--------|------|
| QA팀 | - | 테스트 실행 |
| Backend팀 | - | 성능 분석, 개선 |
| DevOps팀 | - | 인프라 모니터링 |
| Frontend팀 | - | 스크립트 작성 지원 |

---

**문서 버전**: 1.0
**마지막 수정일**: 2026-01-29
**작성자**: Claude (AI Assistant)
